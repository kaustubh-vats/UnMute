let muteBtn,surround=[];const SURROUNDS_VALS=["left","right","top","bottom"],cssUrl=document.currentScript.getAttribute("data-cssurl");let isEnabledAutoTimer="true"===document.currentScript.getAttribute("data-autoTimer"),isEnabledUnmuteOnSpace="true"===document.currentScript.getAttribute("data-spaceShortcut");const isEnabledDarkTheme="true"===document.currentScript.getAttribute("data-darkTheme"),url=location.hostname;let isFoundElseWhere=!1,isMicUnmutedByShortcut=!1,timerInstance,timerContainerInstance=null;const FOUND_MESSAGE="UNMUTE_FOUND",UPDATE_XY_MESSAGE="UNMUTE_UPDATE_TIMER_X",UPDATE_THEME_MESSAGE="UNMUTE_UPDATE_TIMER_THEME",UPDATE_UNMUTE_ON_SPACE_MESSAGE="UNMUTE_UPDATE_TIMER_UNMUTE_ON_SPACE",UPDATE_AUTO_RECORD_MESSAGE="UNMUTE_UPDATE_TIMER_AUTO_RECORD",removeUnmuteListenerOnSpace=()=>{document.removeEventListener("keydown",onKeyDown),document.removeEventListener("keyup",onKeyUp)},attachUnmuteListenerOnSpace=()=>{removeUnmuteListenerOnSpace(),document.addEventListener("keydown",onKeyDown,!0),document.addEventListener("keyup",onKeyUp,!0)},onChangeAutoRecord=e=>{e&&!isEnabledAutoTimer?(sendMessage({message:UPDATE_AUTO_RECORD_MESSAGE,value:!0}),isEnabledAutoTimer=!0):!e&&isEnabledAutoTimer&&(sendMessage({message:UPDATE_AUTO_RECORD_MESSAGE,value:!1}),isEnabledAutoTimer=!1)},onChangeSpaceMute=e=>{e&&!isEnabledUnmuteOnSpace?(attachUnmuteListenerOnSpace(),sendMessage({message:UPDATE_UNMUTE_ON_SPACE_MESSAGE,value:!0}),isEnabledUnmuteOnSpace=!0):!e&&isEnabledUnmuteOnSpace&&(removeUnmuteListenerOnSpace(),sendMessage({message:UPDATE_UNMUTE_ON_SPACE_MESSAGE,value:!1}),isEnabledUnmuteOnSpace=!1)},onChangeDarkTheme=e=>{timerContainerInstance||retturn,e&&!timerContainerInstance.classList.contains("timer-dark")?(timerContainerInstance.classList.add("timer-dark"),sendMessage({message:UPDATE_THEME_MESSAGE,value:!0})):!e&&timerContainerInstance.classList.contains("timer-dark")&&(timerContainerInstance.classList.remove("timer-dark"),sendMessage({message:UPDATE_THEME_MESSAGE,value:!1}))},menuItems=[{label:"Auto record time on unmute",default:!0===isEnabledAutoTimer,onChange:onChangeAutoRecord},{label:"Use space bar to unmute",default:!0===isEnabledUnmuteOnSpace,onChange:onChangeSpaceMute},{label:"Dark theme",default:!0===isEnabledDarkTheme,onChange:onChangeDarkTheme}],getAttributeToListen=()=>url.includes("meet.google")?"data-is-muted":url.includes("zoom")?"aria-label":void 0,getBtnSelector=()=>url.includes("meet.google")?"[aria-label~='microphone']":url.includes("zoom")?".join-audio-container__btn":void 0,ifMuteBtnExist=()=>null!=muteBtn,isMicDisabled=()=>{if(ifMuteBtnExist()){if(url.includes("meet.google"))return"true"==muteBtn.getAttribute("data-is-muted");if(url.includes("zoom")){let e=muteBtn.getAttribute("aria-label").toLowerCase();return e.includes("join audio")||e.includes("unmute")}}return!1},unMuteMic=()=>{isMicDisabled()&&(muteBtn.blur(),muteBtn.click(),isMicUnmutedByShortcut=!0)},muteMic=()=>{!isMicDisabled()&&isMicUnmutedByShortcut&&(muteBtn.click(),isMicUnmutedByShortcut=!1,muteBtn.focus())},getColorClass=()=>isMicDisabled()?"muted":"unmuted",getAltClass=e=>"unmuted"===e?"muted":"unmuted",changeMode=()=>{if(ifMuteBtnExist()&&8===surround.length){let e=getColorClass(),t=getAltClass(e);surround.forEach(n=>{let s=n.classList;s.contains(t)&&(s.remove(t),s.add(e))}),isEnabledAutoTimer&&timerInstance&&timerInstance.handleAutoTimer(e)}},dettachSurroundIfExist=()=>{surround.forEach(e=>{e.remove()})},getBasicSurround=()=>{let e=document.createElement("div");return e.setAttribute("class",`border ${getColorClass()}`),e},removeSurround=()=>{dettachSurroundIfExist(),surround=[]},getCSSUrl=()=>cssUrl||document.querySelector("#unmute__script").getAttribute("data-cssurl"),getPrevX=()=>{let e=document.querySelector("#unmute__script").getAttribute("data-timerx");return"undefined"===e?null:e},getPrevY=()=>{let e=document.querySelector("#unmute__script").getAttribute("data-timery");return"undefined"===e?null:e},removeWrapper=()=>{let e=document.querySelector("unmute-glass");e&&e.remove()};function updateDiv(e,t){if(t){let n=e.reduce((e,t)=>e+t,0)/e.length;t.style.setProperty("--audio-freq",Math.round(100*n)+"px")}}function animate(e,t){let n=new Uint8Array(e.frequencyBinCount);e.getByteFrequencyData(n);let s=[...n].map(e=>e/128);updateDiv(s,t),t&&t.isConnected&&requestAnimationFrame(()=>animate(e,t))}const attachAudioAnimation=e=>{navigator.mediaDevices.getUserMedia({audio:!0}).then(function(t){let n=new AudioContext,s=n.createMediaStreamSource(t),i=n.createAnalyser();i.fftSize=512,s.connect(i),animate(i,e)}).catch(function(e){console.debug("Error accessing microphone:",e)})},checkIfAudioIsPresent=e=>{navigator.permissions.query({name:"microphone"}).then(function(t){"granted"===t.state&&attachAudioAnimation(e)}).catch(function(e){console.debug("Error checking microphone permissions:",e)})},onKeyDown=e=>{" "===e.key&&unMuteMic(e)},onKeyUp=e=>{" "===e.key&&muteMic(e)},createSurround=()=>{removeWrapper();let e=document.createElement("unmute-glass"),t=e.attachShadow({mode:"closed"}),n=document.createElement("div"),s=document.createElement("link");s.rel="stylesheet",s.type="text/css",s.href=getCSSUrl(),t.appendChild(s),n.setAttribute("class","unmute__container"),ifMuteBtnExist()&&(removeSurround(),SURROUNDS_VALS.forEach(e=>{let t=getBasicSurround();t.classList.add(e);let s=t.cloneNode();s.classList.add("opacited"),n.appendChild(t),n.appendChild(s),surround.push(t),surround.push(s)}),isEnabledUnmuteOnSpace&&attachUnmuteListenerOnSpace()),t.appendChild(n),checkIfAudioIsPresent(n),s.onload=()=>{timerContainerInstance=(timerInstance=new Timer(getPrevX(),getPrevY(),n)).createTimer(),n.appendChild(timerContainerInstance)},document.body.appendChild(e)},init=()=>{if(muteBtn=document.querySelector(getBtnSelector())){createSurround();let e=new MutationObserver(e=>{e.forEach(e=>{"attributes"===e.type&&e.attributeName===getAttributeToListen()&&changeMode()})}),t={attributes:!0,attributeFilter:[getAttributeToListen()]};e.observe(muteBtn,t)}else removeSurround()};window.addEventListener("message",e=>{try{let t=JSON.parse(e.data);t.message===FOUND_MESSAGE&&e.source!==window&&(isFoundElseWhere=t.value)}catch(n){}});const sendMessageForIsFound=e=>{let t={message:FOUND_MESSAGE,value:e};sendMessage(t)},sendMessage=e=>{window.postMessage(JSON.stringify(e),"*"),window.top.postMessage(JSON.stringify(e),"*")},handleMessage=e=>{!e&&muteBtn?sendMessageForIsFound(!1):e&&sendMessageForIsFound(!0)},domObserver=new MutationObserver(()=>{if(isFoundElseWhere||muteBtn&&muteBtn.isConnected)return;let e=document.querySelector(getBtnSelector());handleMessage(e),e!==muteBtn&&init()});class Timer{constructor(e,t,n){this.x=e??50,this.y=t??50,this.minutesElement,this.secondsElement,this.minutes=0,this.seconds=0,this.timerInterval,this.dragStartX=0,this.dragStartY=0,this.controlButton=void 0,this.isAutoRecording=!1,this.menuUpdateTimeout=null,this.container=n}createTimer=()=>{let e=document.createElement("div");e.classList.add("timer-container");let t=document.createElement("div");t.classList.add("timer"),this.minutesElement=document.createElement("span"),this.minutesElement.id="minutes",this.minutesElement.textContent="00";let n=document.createTextNode(":");this.secondsElement=document.createElement("span"),this.secondsElement.id="seconds",this.secondsElement.textContent="00",t.appendChild(this.minutesElement),t.appendChild(n),t.appendChild(this.secondsElement);let s=document.createElement("div");s.classList.add("controls");let i=document.createElement("button");i.id="startBtn",i.className="resume",i.title="Pause / Resume Timer",this.controlButton=i;let a=document.createElement("button");a.id="resetBtn",a.title="Reset Timer",a.className="resetIcon";let r=document.createElement("div");r.setAttribute("class","timer-wrapper");let u=document.createElement("div");u.setAttribute("class","menu-container");let o=null,l=null;menuItems.forEach(e=>{let t=document.createElement("div");t.setAttribute("class","menu-item");let n=document.createElement("div");n.textContent=e.label;let s=document.createElement("input");s.setAttribute("class","menu-checkbox"),s.setAttribute("type","checkbox"),s.addEventListener("change",t=>{e.onChange(t.target.checked)}),s.checked=e.default,o||(o=s),l=s,t.appendChild(n),t.appendChild(s),u.appendChild(t)});let d=document.createElement("div");function c(t){let n=t?.target;!(n&&u&&(u===n||u.contains(n)))&&(e.classList.toggle("expanded-menu"),e.classList.contains("expanded-menu")?(o.focus(),l.addEventListener("keydown",t=>{"Tab"!==t.key||t.shiftKey||(e.focus(),t.preventDefault())}),e.setAttribute("aria-label","click to toggle menu list, menu list open")):e.setAttribute("aria-label","click to toggle menu list, menu list closed"))}function m(t){t.dataTransfer.setData("text/plain",t.target.id),t.dataTransfer.dropEffect="move";let n=t.clientX,s=t.clientY,i=e.getBoundingClientRect();this.dragStartX=n-i.x,this.dragStartY=s-i.y}function h(t){let n=t.clientX,s=t.clientY,i=n-this.dragStartX,a=s-this.dragStartY;this.setTimerXAndY(e,i,a,u,this.menuUpdateTimeout,this),this.updateScriptAndExtension(i,a)}d.setAttribute("class","timer-flex-container"),d.appendChild(i),d.appendChild(t),d.appendChild(a),r.appendChild(d),r.appendChild(u),e.appendChild(r),e.setAttribute("draggable","true"),e.setAttribute("tabindex","0"),e.setAttribute("aria-label","click to toggle menu list"),e.classList.add("menu-top"),e.addEventListener("dragstart",m.bind(this)),e.addEventListener("dragend",h.bind(this)),e.addEventListener("click",c),e.addEventListener("keydown",e=>{"Enter"==e.key&&c(e)}),isEnabledDarkTheme&&e.classList.add("timer-dark"),i.addEventListener("click",(function(e){this.timerInterval?(clearInterval(this.timerInterval),this.timerInterval=null,i.className="resume"):(this.timerInterval=setInterval(this.updateTimer.bind(this),1e3),i.className="play",this.isAutoRecording=!1),e.stopPropagation()}).bind(this)),a.addEventListener("click",(function(e){clearInterval(this.timerInterval),this.timerInterval=null,this.minutes=0,this.seconds=0,this.updateTimerDisplay(),i.className="resume",e.stopPropagation()}).bind(this));let E=document.createElement("div");return E.setAttribute("class","hidden-div"),E.appendChild(e),this.container.appendChild(E),this.setTimerXAndY(e,this.x,this.y,u,this.menuUpdateTimeout,this),e.remove(),E.remove(),window.addEventListener("resize",(()=>{this.setTimerXAndY(e,this.x,this.y,u,this.menuUpdateTimeout,this)}).bind(this)),e};handleAutoTimer(e){"unmuted"!==e||this.timerInterval?"muted"===e&&this.timerInterval&&this.isAutoRecording&&(clearInterval(this.timerInterval),this.timerInterval=null,this.controlButton&&(this.controlButton.className="resume"),this.isAutoRecording=!1):(this.timerInterval=setInterval(this.updateTimer.bind(this),1e3),this.controlButton&&(this.controlButton.className="play"),this.isAutoRecording=!0)}updateScriptAndExtension(e,t){let n=document.querySelector("#unmute__script");n&&(n.setAttribute("data-timerx",e),n.setAttribute("data-timery",t)),sendMessage({message:"UNMUTE_UPDATE_TIMER_X",value:{x:e,y:t}})}setTimerXAndY(e,t,n,s,i,a){let r=e.getBoundingClientRect();t<0&&(t=0),n<0&&(n=0),t>document.documentElement.clientWidth-r.width&&(t=document.documentElement.clientWidth-r.width),n>document.documentElement.clientHeight-r.height&&(n=document.documentElement.clientHeight-r.height),a.x=t,a.y=n,e.style.setProperty("--timer-x",`${t}px`),e.style.setProperty("--timer-y",`${n}px`),i&&(clearTimeout(i),i=null),i=setTimeout(()=>{let t=s.getBoundingClientRect(),n=e.classList.contains("menu-bottom")?"bottom":"top";t.y<0&&(n="bottom"),t.y+t.height>document.body.clientHeight&&(n="top"),"top"!==n||e.classList.contains("menu-top")?"bottom"!==n||e.classList.contains("menu-bottom")||(e.classList.contains("menu-top")&&e.classList.remove("menu-top"),e.classList.add("menu-bottom")):(e.classList.contains("menu-bottom")&&e.classList.remove("menu-bottom"),e.classList.add("menu-top")),clearTimeout(i),i=null},100)}updateTimer(){this.seconds++,60===this.seconds&&(this.minutes++,this.seconds=0),this.updateTimerDisplay()}updateTimerDisplay(){this.minutesElement&&this.secondsElement&&(this.minutesElement.textContent=this.padZero(this.minutes),this.secondsElement.textContent=this.padZero(this.seconds))}padZero(e){return e<10?`0${e}`:e}}window.customElements.define("unmute-glass",class extends HTMLElement{constructor(){super()}}),domObserver.observe(document.body,{subtree:!0,childList:!0}),init();